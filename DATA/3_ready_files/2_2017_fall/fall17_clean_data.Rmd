---
title: "Fall 2017 Data Cleaning"
author: "Amy Rae Fox"
date: "11/2/2021"
output:
  html_document: default
  pdf_document: default
---

*The purpose of this file is processing the combined data files for Fall 2017 into study-level files that contain only valid data for analysis, excluding invalid sessions and conditions.*

```{r SETUP, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
library(jsonlite)
library(tidyjson)
library(dplyr)

#set current folder as working directory
# setwd("~/Sites/RESEARCH/SGCâ€”Scaffolding Graph Comprehension/SGC-X/DATA/3_ready_files/fall_2017")
```

Data is imported from 2 files, indicating two levels of analysis: participants and blocks (item-level). **Note: mouse-cursor data contained in final_mouse_blocks.json file is not handled here.**

```{r IMPORT}
#IMPORT DATA
df_participants <- fromJSON("combined_files/final_participants.json")
df_blocks <- fromJSON('combined_files/final_blocks.json')

#add term indicator
df_participants$term <- "fall17"
df_blocks$term <- "fall17"

```

```{r PARTICIPANTS-SETUP}

#create factors in PARTICIPANTS
df_participants <- df_participants %>%  
  dplyr::select(subject,session,term,condition,  #re-arrange columns
         ts_n, tt_n,triangular_score,
         os_n, ot_n,orthogonal_score,
         explicit,impasse,axis,
         triangular_time, totalTime, ts_t, tt_t,
         attn_check,
         native_language, year, major, country, sex, age
         ) %>% #reorder columns 
  mutate( #create factors and remove extraneous ""
    subject=factor(subject),
    condition=factor(condition),
    session=factor(session),
    term=factor(term),
    explicit=factor(explicit),
    axis=factor(axis),
    impasse=factor(impasse),
    sex = as.factor(gsub('"',"",sex)),
    age = as.double(gsub('"',"",age)),
    country = gsub('"',"",country),
    major = gsub('"',"",major),
    year = gsub('"',"",year),
    native_language = gsub('"',"",native_language),
) 

```

```{r BLOCKS-SETUP}
df_blocks <- df_blocks %>% 
  dplyr::select( #reorder columns
    subject, session, term, condition,
    q,question,answer,rt,
    correct, orth_correct,
    explicit, impasse, axis) %>% 
  mutate(
    subject=factor(subject),
    condition=factor(condition),
    session=factor(session),
    term=factor(term),
    explicit=factor(explicit),
    axis=factor(axis),
    impasse=factor(impasse),
    q=factor(q),
    question=factor(question)
  )
```

### Reconciling Submissions

In Fall 2017, exclusion criteria were implemented in the database data wrangling step. To reconcile number of submissions (vs) number of successfully completed we compare the number of entries in the analysis database, (vs) the number of entries in the imported analysis file (post-db-wrangling).

```{r STUDIES}
#MANUALLY INSPECT studies
df_participants %>% group_by(condition) %>% 
  dplyr::summarize(n=n())
```

-   A total of 54 subjects (111 : 27, 121: 27) successfully completed study SGC3A (in person).
-   A total of 10 subjects (113 : 10) successfully completed a pilot of study SGC4A (in person).
-   A total of 10 subjects (211 : 30, 221:30, 311:30, 321:30) successfully completed study SGC3B (in person). Note that the 111 and 121 conditions of study SGC3A are included in SGC3B for analysis.

**NOTE** Manual inspection of database after importing Fall 2017 data indicates:

-   SGC3A: 68 subjects submitted study
    -   33 subjects completed condition 111; 35 subjects completed condition 121
    -   **thus**; 68 - 54 = 14 subjects were excluded during wrangling, for failing the attention check question. (Exclusion took part in database wrangling process)
-   SGC4A: 16 subjects submitted pilot SGC4A
    -   113 : 6 112: 10
    -   thus no participants were excluded in wrangling
-   SGC3B : 130 subjects submitted SGC3B [not including SGC3A 111 and 121 conditions, above]
    -   211: 36, 221:32, 311: 32, 321: 30

    -   thus 130 - 120 = 10 subjects were excluded during wrangling

### Sessions

The (string) session code is entered by the participant based on instructions given by the experimenter, and documents the data-collection session (eg. in-person at a particular time). This code is also used by the experimenter to differentiate test or expert data collection runs.

```{r SESSIONS}

#MANUALLY INSPECT sessions
df_participants %>% dplyr::group_by(session) %>% 
  summarize(n=n())

#manually recode sessions in participants
df_participants$session <- recode(df_participants$session,
                                  'alpha'='alfa',
                                  '111'="XTRA")

#manually recode sessions in blocks
df_blocks$session <- recode(df_blocks$session,
                                  'alpha'='alfa',
                                  '111'="XTRA")

df_participants %>% group_by(session) %>% 
  arrange(desc(session)) %>% 
  summarize(n=n())
```

In Fall 2017, 14 data collection sessions were used, from ALFA -\> PINECONE. Participants who mispelled their sessions have been manually recoded, and one participant erroneously entered their condition code as their session code, and this entry is corrected to 'XTRA'.

**No data need to be excluded based on SESSION CODE.**

### Conditions

The three digit condition code is entered by the participant based on instructions given by the experimenter, and determines the stimulus that the participant experiences during the study.

```{r CONDITIONS}
df_participants %>% group_by(condition) %>% 
  summarize(n=n())

#SET CONDITION FACTORS FOR EACH STUDY
#SGC3A is the simple insight study, control (111) vs impasse (121)
f_sgc3a <- c(111,121) 

#SGC3B is the factorial insight study (111 control, 121 insight, 211 static, 221 static-impasse, 311 ixn 321 ixn-impasse)

f_sgc3b <- c(111,121,211,221,311,321)

#SGC4 is the gridlines study 111, 112, 113
f_sgc4 <- c(111,112,113)
```

In Fall 2017, data were gathered for three study designs: SGC3A (simple insight vs. control), SGC3B (partial data collected: full factorial insight vs. explicit) and SGC4(partial data collected:gridlines).

Finally, data from the master participants and blocks files are segregated into separate files for each individual study, separated by condition.

```{r GENERATE FILES}

#SEPARATE PARTICIPANTS FILES
df_sgc3a <- df_participants %>% filter (condition %in% f_sgc3a)
df_sgc3a %>% group_by(condition) %>% 
  summarize(n=n())
write.csv(df_sgc3a,"study_files/fall17_sgc3a_participants.csv", row.names = FALSE)

df_sgc3b <- df_participants %>% filter (condition %in% f_sgc3b)
df_sgc3b %>% group_by(condition) %>% 
  summarize(n=n())
write.csv(df_sgc3b,"study_files/fall17_sgc3b_participants.csv", row.names = FALSE)

df_sgc4 <- df_participants %>% filter (condition %in% f_sgc4)
df_sgc4 %>% group_by(condition) %>% 
  summarize(n=n())
write.csv(df_sgc4,"study_files/fall17_sgc4a_participants.csv", row.names = FALSE)

#SEPARATE BLOCKS FILES
df_sgc3a <- df_blocks %>% filter (condition %in% f_sgc3a)
df_sgc3a %>% group_by(condition) %>% 
  summarize(n=n())
write.csv(df_sgc3a,"study_files/fall17_sgc3a_blocks.csv", row.names = FALSE)

df_sgc3b <- df_blocks %>% filter (condition %in% f_sgc3b)
df_sgc3b %>% group_by(condition) %>% 
  summarize(n=n())
write.csv(df_sgc3b,"study_files/fall17_sgc3b_blocks.csv", row.names = FALSE)

df_sgc4 <- df_blocks %>% filter (condition %in% f_sgc4)
df_sgc4 %>% group_by(condition) %>% 
  summarize(n=n())
write.csv(df_sgc4,"study_files/fall17_sgc4a_blocks.csv", row.names = FALSE)

```
