---
title: "Winter 2022 SGC 3A Data Cleaning"
author: "Amy Rae Fox"
date: "02/22/2022"
output:
  html_document:
    code_folding: hide
    toc: true
    toc_depth: 3
    toc_float:
      collapsed: false
      smooth_scroll: false
  # html_document: default
  pdf_document: default
---

*The purpose of this file is processing the combined data files for Winter 2021 into study-level files that contain only valid data for analysis, excluding invalid sessions and participants*

```{r SETUP, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
library(jsonlite)
library(tidyjson)
library(dplyr)
```

Data is imported from 2 files, indicating two levels of analysis: participants and blocks (item-level). 

**Note: mouse-cursor data contained in final_mouse_blocks.json file is not handled here.**

```{r IMPORT}

#IMPORT DATA
df_participants <- fromJSON("combined_files/winter22_sgc3a_final_participants.json")
df_items <- fromJSON('combined_files/winter22_sgc3a_final_items.json')

#add term indicator
df_participants$term <- "winter22"
df_items$term <- "winter22"

#DEFINE SGC_3A validity crieria
sessions <- c('wi22sona') #SGC3A second online replication on SONA 
conditions <-c(111,121) #2 conditions
violation_threshold = 3 #number of allowable browser violations
effort_exclusion = c("I didn't try very hard, or rushed through the questions")

#placeholder for excluding participants
ex_participants = data.frame()
```

```{r PARTICIPANTS-SETUP}

#create factors in PARTICIPANTS
df_participants <- df_participants %>%  
  mutate( #create factors and remove extraneous ""
    subject=factor(subject),
    condition=factor(condition),
    session=factor(session),
    term=factor(term),
    sex = as.factor(gender),
    age = as.integer(age),
    country = gsub('"',"",country),
    year = factor(schoolyear),
    native_language = factor(language)
   ) %>% select(
     -"_id"
   )  

```

```{r ITEMS-SETUP}

df_items <- df_items %>% 
  mutate(
    subject=factor(subject),
    condition=factor(condition),
    session=factor(session),
    term=factor(term),
    explicit=factor(explicit),
    grid=factor(grid),
    impasse=factor(impasse),
    q=factor(q)
  ) %>% select(
     -"_id"
   ) 
```

## Data Validation


### Completion Status

Starting with Winter 2022, data are saved to the database even if the subject's browser did not meet minimum specifications (at which point they are prompted to change browsers, or end the study). This allows us to learn about the browsers, screen sizes and OS that (potential) subjects are using. However, these data are _not_ exported from the database for analysis (see flatten.js and status.js scripts). Thus, only subjects who successfully completed the entire study are included in this file. 

```{r inspect-STATUS, message=FALSE}
#MANUALLY INSPECT status
df_participants %>% group_by(status) %>% 
  dplyr::summarize(n=n())
```

```{r handle-STATUS}

#DISCARD participants from invalid sessions 
exclude_status <- df_participants %>% 
          filter(status != "success") %>% 
          mutate(reason="invalid-status")

ex_participants <- rbind(ex_participants, exclude_status)
rm(exclude_status)     

df_participants <- df_participants %>% 
  filter( ! subject %in% ex_participants$subject)

```

_No data need to be excluded on account of completion status._

### Conditions

Participants are randomly assigned to an experimental condition when starting the study. Here we validate that only conditions for the current study are included in this dataset.

```{r inspect-CONDITIONS,message=FALSE}
#MANUALLY INSPECT conditions
df_participants %>% group_by(condition) %>% 
  dplyr::summarize(n=n())
```

Data from conditions _not_ corresponding to valid conditions should be discarded. 

```{r handle-CONDITIONS}

#DISCARD participants from conditions invalid for this study
exclude_condition <- df_participants %>% 
          filter(!condition %in% conditions) %>% 
          mutate(reason="invalid-condition")

ex_participants <- rbind(ex_participants, exclude_condition)
rm(exclude_condition)     

df_participants <- df_participants %>% 
  filter( ! subject %in% ex_participants$subject)

```

_No data need to be excluded on account of condition._

### Sessions

The (string) `session code` is embedded in the URL querystring by the experimenter to differentiate testing sessions in SONA from demo and other environment setup tasks. 

```{r inspect-SESSIONS,message=FALSE}
#MANUALLY INSPECT sessions
df_participants %>% group_by(session) %>% 
  dplyr::summarize(n=n())
```

Data from sessions not corresponding to valid sessions should be discarded. 

```{r handle-SESSIONS}

#DISCARD participants from invalid sessions 
exclude_session <- df_participants %>% 
          filter(!session %in% sessions) %>% 
          mutate(reason="invalid-session")

ex_participants <- rbind(ex_participants, exclude_session)
rm(exclude_session)     

df_participants <- df_participants %>% 
  filter( ! subject %in% ex_participants$subject)

```

_No data need to be excluded on account of session._

### Browser Interaction Violations

Browser interaction data is recorded by jspsych allowing us to determine if subjects violate our instructions not to leave the browser tab (or exit fullscreen mode) during test. These incidents are recorded in jspsych interaction data object, and the number of violations is counted and added to the participant data file. 

Due to eccentricity of the browser events captured, 1-2 browser violations can be captured even if the subject did not leave the browser window (eg. in case of resizing window to meet minimum requirements.)

```{r inspect-VIOLATIONS, message=FALSE}
#MANUALLY INSPECT violations
df_participants %>% group_by(violations) %>% 
  dplyr::summarize(n=n())
```
```{r handle-VIOLATIONS}

#DISCARD participants exceeding the threshold of browser interaction violations 
exclude_violations <- df_participants %>% 
          filter(violations > violation_threshold) %>% 
          mutate(reason="exceeded-violations")

ex_participants <- rbind(ex_participants, exclude_violations)
rm(exclude_violations)     

df_participants <- df_participants %>% 
  filter( ! subject %in% ex_participants$subject)

```

_Two participants were excluded for exceeding the maximum allowed number of browser interaction violations._


### Effort

To assist in mitigating increased noise in data collected asynchronously from the UCSD student subject pool, we added explicit ratings of how much effort the participant expended on the task. This question was implemented as a multiple-choice drop-down on an 'Effort' page prior to the 'Demographics' survey at the end of the study. Subjects were given four options : (1) I tried my best on each question, (2) I tried my best on most questions, (3) I started out trying hard, but gave up at some point, (4) I didn't try very hard, or rushed through the questions.


```{r inspect-EFFORT, message=FALSE}
#MANUALLY INSPECT effort
df_participants %>% group_by(effort) %>% 
  dplyr::summarize(n=n())
```
Participants answering with options _I didn't try very hard, or rushed through the questions_ are excluded for all analyses. 
Participants answering _I started out trying hard, but gave up at some point_ **are** included in analysis, as we are interested in problem sovling strategy under the condition of losing motivation. 

```{r handle-EFFORT}

#DISCARD participants who indicated they did not expend adequate effort on the study
exclude_effort <- df_participants %>% 
          filter(effort %in% effort_exclusion) %>% 
          mutate(reason="selfrated-effort")

ex_participants <- rbind(ex_participants, exclude_effort)
rm(exclude_effort)     

df_participants <- df_participants %>% 
  filter( ! subject %in% ex_participants$subject)
```

_Three participants are excluded for low (self-rated) effort._



### Attention Check

The 6th question in the study is non-discriminatory (can easily get correct answer regardless of strategy) and serves as an attention check question. 

```{r inspect-ATTN, message=FALSE}
#MANUALLY INSPECT attention
df_participants %>% group_by(attn_check) %>% 
  dplyr::summarize(n=n())
```

Participants who answered the attention check question incorrectly should be excluded. 

```{r handle-ATTN}

#DISCARD participants who indicated they did not expend adequate effort on the study
exclude_attn <- df_participants %>% 
          filter(attn_check == FALSE) %>% 
          mutate(reason="failed-attnchk")

ex_participants <- rbind(ex_participants, exclude_attn)
rm(exclude_attn)     

df_participants <- df_participants %>% 
  filter( ! subject %in% ex_participants$subject)
```

_Nine participants are excluded for failing the attention check question._


### Items

Finally, we need to discard item_level data for excluded participants. 

```{r FILTER-ITEMS}

ex_items <- df_items %>% 
  filter (subject %in% ex_participants$subject) 

df_items <- df_items %>% 
  filter (!subject %in% ex_participants$subject )
```


## Data Export


### Save Exclusions

For transparency, we save and identify the excluded data. 

```{r save-EXCLUSIONS}

write.csv(ex_participants,"study_files/excluded_participants.csv", row.names = FALSE)
write.csv(ex_items,"study_files/excluded_items.csv", row.names = FALSE)

```



### Analysis-Ready Files

```{r GENERATE-FILES}

#save participant file

write.csv(df_participants,"study_files/winter22_sgc3a_participants.csv", row.names = FALSE)

#save item file
write.csv(df_items,"study_files/winter22_sgc3a_items.csv", row.names = FALSE)

 

```

