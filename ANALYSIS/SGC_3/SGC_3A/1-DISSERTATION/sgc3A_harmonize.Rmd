---
title: 'SGC_3A: The Insight Hypothesis'
subtitle: 'Primary Analysis for SGC3A'
author: 'Amy Rae Fox'
always_allow_html: true  
output:
  html_document:
    theme: yeti
    code_folding: hide
    fig_caption: yes
    number_sections: yes
    toc: yes
    toc_depth: 4
    toc_float:
      collapsed: no
      smooth_scroll: yes
  pdf_document: 
    toc: true
    toc_depth: 3
    latex_engine: xelatex
font-family: "DejaVu Sans"
mainfont: "DejaVu Sans"
---

\newpage  

```{r SETUP, include=FALSE}
knitr::opts_chunk$set(echo = TRUE, warning = FALSE, message = FALSE) 

#IMPORT LIBRARIES
library(tidyverse) #ALL THE THINGS

```

*The purpose of this notebook is to harmonize data files for study SGC_3A.*

# INTRODUCTION 
Data for study SGC_3A were collected across four time periods, interrupted by the Covid-19 pandemic. 
Fall 2017: in person, SONA groups in computer lab
Spring 2018: in person, SONA groups in computer lab
Fall 2021: asynchronous, online, SONA
Winter 2022: asynchronous, online, SONA

Data collected in Fall 2017, Spring 2018 constitute the original SGC_3A study, conducted in person. Data collected in Fall 2021, Winter 2022 constitute the web-based replication, conducated online (asynchronously). 

## VALIDATION

```{r IMPORT-SUBJECTS}
#IMPORT PARTICIPANT DATA

#set datafiles
fall17 <- "data/fall17_sgc3a_participants.csv"
spring18 <- "data/spring18_sgc3a_participants.csv"
fall21 <- "data/fall21_sgc3a_participants.csv"
winter22 <- "data/winter22_sgc3a_participants.csv"

#read datafiles, set mode and term
df_subjects_fall17 <- read.csv(fall17) %>% mutate(mode = "lab-synch", term = "fall17")
df_subjects_spring18 <- read.csv(spring18) %>% mutate(mode = "lab-synch", term = "spring18")
df_subjects_fall21 <- read.csv(fall21) %>% mutate(mode = "online-asynch", term = "fall21")
df_subjects_winter22 <- read.csv(winter22) %>% mutate(mode = "online-asynch", term = "winter22")

#reduce data collected using old webapp
df_subjects <- rbind(df_subjects_fall17, df_subjects_spring18, df_subjects_fall21) %>% 
  mutate(
    totaltime_m = totalTime / 1000 / 60,  
    absolute_score = triangular_score) %>% 
  dplyr::select(subject, condition, session, term, mode, sex, age, totaltime_m, absolute_score)

#reduce data collected using new webapp
df_subjects_winter22 <- df_subjects_winter22 %>% 
  mutate(score = absolute_score, sex = gender) %>% 
  dplyr::select( subject, condition, session, term, mode, sex, age, totaltime_m, absolute_score)

#combine dataframes from old and new webapps
df_subjects <- rbind(df_subjects, df_subjects_winter22) %>% 
  mutate(
    subject = as.factor(subject),
    condition = as.factor(condition),
    session = as.factor(session),
    term = as.factor(term),
    mode = as.factor(mode),
  )

rm(df_subjects_fall17,df_subjects_fall21, df_subjects_spring18, df_subjects_winter22)
```


```{r IMPORT-ITEMS}

#set datafiles
fall17 <- "data/fall17_sgc3a_blocks.csv"
spring18 <- "data/spring18_sgc3a_blocks.csv"
fall21 <- "data/fall21_sgc3a_blocks.csv"
winter22 <- "data/winter22_sgc3a_items.csv"

#read datafiles, set mode and term
df_items_fall17 <- read.csv(fall17) %>% mutate(mode = "lab-synch", term = "fall17")
df_items_spring18 <- read.csv(spring18) %>% mutate(mode = "lab-synch", term = "spring18")
df_items_fall21 <- read.csv(fall21) %>% mutate(mode = "online-asynch", term = "fall21")
df_items_winter22 <- read.csv(winter22) %>% mutate(mode = "online-asynch", term = "winter22")

#get relations mapping encoded in winter22 data files
map_relations <- df_items_winter22 %>% group_by(q) %>% select(q,relation) %>% unique()
  
#reduce data collected using old webapp
df_items <- rbind(df_items_fall17, df_items_spring18, df_items_fall21) %>% 
  mutate(rt_s = rt / 1000) %>% 
  select(subject, condition, term, mode, question, q, answer, correct, rt_s)
  
#reduce data collected using new webapp
df_items_winter22 <- df_items_winter22 %>% 
  select(subject, condition, term, mode, question, q, answer, correct, rt_s)

#combine dataframes from old and new webapps
df_items <- rbind(df_items, df_items_winter22) %>% 
  mutate(
    subject = as.factor(subject),
    condition = as.factor(condition),
    term = as.factor(term),
    mode = as.factor(mode),
    question = as.factor(question),
    q = as.factor(q),
    answer = as.factor(answer)
  )

#separate 'free response' items into independent dataframe 
df_freeresponse <- df_items %>% filter(q == 16)
df_items <- df_items %>% filter (q != 16)

rm(df_items_fall17,df_items_fall21, df_items_spring18, df_items_winter22)
```

```{r RECONCILE}

#the number of items should be equal to 15 x the number of subjects
nrow(df_items) == 15* nrow(df_subjects) #TRUE

#each subject should have 15 items
df_items %>% group_by(subject) %>% summarise(n = n()) %>% filter(n != 15) %>% nrow() == 0

```
_All collection periods have the correct number of blocks (i.e. items) based on the number of included participants, except for Spring 2018. Some subjects from Spring 2018 have 15 records, and others have 16. This reflects the addition of the free-response (q #16) near the start of the quarter._ 


## RESCORE ITEMS

```{r KEY}
key_111 <- read_csv('static/SGC3A_111_key.csv')
key_121 <- read_csv('static/SGC3A_121_key.csv')
```





```{r}
# 
# #strip punctuation from response (this was added in some version of the web app and not others)
# try <- df_items %>% sample_n(10)
# 
# 
# 
# test <- df_items %>% filter( (q == 1) & (condition == "111")) %>% sample(10)
# 
# # names = c("q1", "q2", "q3", "q4","q5", "q6", "q7", "q8","q9", "q10", "q11", "q12","q13", "q14", "q15")
# 
# 
# 
# key = "F"
# test = data.frame(answer=c("F","A","AF","FA",""))
# 
# 
# #calculate absolute score
# #answer is detected, and string is of same length
# test$score_absolute <- (str_detect(test$answer,key)) & (nchar(test$answer) == nchar(key))
# test$score_partial <- str_count(test$answer,key)
# test
# 
# 
# ##NEXT GET ACTUAL SCORING LOGIC FROM JAVASCRIPT FILE
# 
# 
# #calculate absolute score
# #TRUE if absolute match, otherwise FALSE
# # test$score_absolute <- str_detect(test$answer, key_111[1,]$CORRECT)
# # test$score_absolute <- str_count(test$answer, paste('^',key_111[1,]$CORRECT,'$'))
# try$score_absolute <- str_detect(try$answer, key_111[1,]$CORRECT)
# # text anchor start ^ end $
# # test$score_triangular <- str_detect(test$answer, paste('^',key_111[1,]$TRIANGULAR,'$'))
# 
# try %>% select(answer,correct,score_absolute)
```
>>strip punctuation
>>remove non-discriminant questions

## SUMMARIZE PARTICIPANTS

>> add free response to dataframe

# EXPORT 