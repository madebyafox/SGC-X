---
title: "SGC 3A Data Reconilliation"
output: 
# rmdformats::robobook:
  html_document:
    code_folding: hide
    toc: true
    toc_depth: 3
    toc_float:
      collapsed: false
      smooth_scroll: false
---

*The purpose of this notebook is to harmonize data files for study SGC_3A.*
**TODO :: power analysis**


```{r SETUP, include=FALSE}
knitr::opts_chunk$set(echo = TRUE, warning = FALSE, message = FALSE) 

#IMPORT LIBRARIES
library(dplyr) #tidyverse data handling
library(dataMeta) #create a data dictionary
```


# INTRODUCTION 
Data for study SGC_3A were collected across four time periods, interrupted by the Covid-19 pandemic. 
Data for the original study were collected in Fall 2017, Spring 2018 in person, inviting groups of SONA pool students to complete the study simultaneously in a campus computer lab. Additional data were collected in Fall 2021 as an asynchronous, online study to the same SONA subject pool.  Preliminary analsyes of these data suggest that the data collected online were 'noisier' (eg. with a higher effort dropoff rate characterized by faster response times and decreased accuracy at the end of the study). In an effort to mitigate this circumstance, we collected additional data in Winter 2022 that included information about the participant's browser activity and self-rated effort, allowing us to discard students who either fail to follow instructions, or self-disclose that they 'clicked through' the study in order to get SONA credit. 

Period       Mode                 Pool      Purpose 
-------     ------                -------   ---------- 
Fall 2017   in person               SONA    original study
Spring 2018 in person               SONA    original study
Fall 2021   asynchronous, online    SONA    online replication
Winter 2022 asynchronous, online    SONA    online replication

Over the course of data collection, however, enhancements to the underlying web application used to collect data necessitated database schema changes, and therefore the variables (and variable names) included in files across the study are not the same.  

**The purpose of this notebook is to harmonize the data structure across files, yielding a single set of consistent variables for analysis.**


# DATA SETUP

```{r IMPORT-DATA-ITEMS}

#IMPORT DATA from all four data collection periods
items_fall17 <- read.csv("data/fall17_sgc3a_blocks.csv")
items_spring18 <- read.csv("data/spring18_sgc3a_blocks.csv")
items_fall21 <- read.csv("data/fall21_sgc3a_blocks.csv")
items_winter22 <- read.csv("data/winter22_sgc3a_items.csv")

#SET study modality
items_fall17$mode <- "lab"
items_spring18$mode <- "lab"
items_fall21$mode <- "online"
items_winter22$mode <- "online"

#SET data format
items_fall17$format <- "legacy"
items_spring18$format <- "legacy"
items_fall21$format <- "legacy"
items_winter22$format <- "new"

legacy_items <- rbind(items_fall17, items_fall21, items_spring18)
new_items <- items_winter22

```

```{r IMPORT-DATA-SUBJECTS}  

#IMPORT DATA from all four data collection periods
subjects_fall17 <- read.csv("data/fall17_sgc3a_participants.csv")
subjects_spring18 <- read.csv("data/spring18_sgc3a_participants.csv")
subjects_fall21 <- read.csv("data/fall21_sgc3a_participants.csv")
subjects_winter22 <- read.csv("data/winter22_sgc3a_participants.csv")

#indicate study modality
subjects_fall17$mode <- "lab"
subjects_spring18$mode <- "lab"
subjects_fall21$mode <- "online"
subjects_winter22$mode <- "online"

#indicate data format
subjects_fall17$format <-   "legacy"
subjects_spring18$format <- "legacy"
subjects_fall21$format <-   "legacy"
subjects_winter22$format <- "new"

##TEMPORARILY combine data files 
legacy_subjects <- rbind(subjects_fall17, subjects_spring18, subjects_fall21) 
new_subjects <- subjects_winter22

```

First, we restructure the legacy dataframe to match the new dataframe
```{r}
#REFACTOR legacy PARTICIPANT dataframe

legacy_subjects <- legacy_subjects %>% 
  #drop redundant subject-level fields, should be on item
  select(-explicit,-impasse,-axis) %>% 
  mutate(
    attn_check = as.logical(attn_check), #should all be true, as false is excluded in cleaning)
    study = "SGC3A", #only dealing with SGC3A
    pool = "sona", #all from sona pool
    sona_id = 0, #didn't record
    exp_id =  0, #didn't record
    status = "success", #browser failures aren't allowed to get that far
    absolute_score = triangular_score,
    discriminant_score = "TODO",
    tri_score = triangular_score,
    orth_score = orthogonal_score,
    other_score = "TODO",
    blank_score = "TODO",
    starttime = "NA",
    totaltime = totalTime,
    explanation = "TODO",
    browser = "blank",
    width = "blank",
    height = "blank",
    os = "blank",
    violations = "blank",
    effort = "blank",
    difficulty = "blank",
    confidence = "blank",
    enjoyment = "blank",
    other = "blank",
    language = "blank",
    schoolyear = "blank",
    gender = "blank",
    disability = "blank"
  ) %>%  
  #drop summary scoring by phase, should be done manually on items
  select(-ts_n, -tt_n, -os_n, -ot_n) %>% 
  #drop redundant scoring fields
  select(-triangular_score, -orthogonal_score) %>%
  #drop redundant time fields
  select(-ts_t, -tt_t, -totalTime, -triangular_time)
  
```

Next, we join the dataframes to validate they share structure
```{r}
df_subjects <- rbind(legacy_subjects, new_subjects)
df_subjects$totaltime_min <- df_subjects$totaltime/ 1000 / 60

```
TODO:: rescoring algorithm
TODO :: join explanation free response from legacy to participants




########### 
#combine files by data collection modality
df_lab <- rbind(fall_17, spring_18)
df_online <- rbind(fall_21, winter_22)

#indicate study modality
df_lab$mode <- "lab"
df_online$mode <- "online"

# #Create combined data frame
# df_subjects <- rbind(df_lab, df_online)
# 
# df_subjects$tri_min <- df_subjects$triangular_time / 1000 / 60
# df_subjects$test_min <- df_subjects$tt_t / 1000 / 60
# df_subjects$learn_min <- df_subjects$ts_t / 1000 / 60
# 
# #Create factors 
# df_subjects <- df_subjects %>% mutate(
#   subject = as.factor(subject),
#   session = as.factor(session),
#   term = as.factor(term),
#   condition = as.factor(condition),
#   explicit = as.factor(explicit),
#   impasse = as.factor(impasse),
#   axis = as.factor(axis)
# )
# 
# df_fall <- df_subjects %>% filter(term =="fall17")
# df_spring <- df_subjects %>% filter(term =="spring18")
# df_online <- df_subjects %>% filter(term =="fall21")
# df_lab <- df_subjects %>% filter(term != "fall21")
```

```{r}
#Build a data dictionary for legacy data structure
# prompt_linker(df_legacy)
```


